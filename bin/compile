#!/usr/bin/env bash

GHC_PACKAGE_URL="http://s3.amazonaws.com/heroku-buildpack-haskell/ghc.tar.gz"
CABAL_PACKAGE_URL="http://s3.amazonaws.com/heroku-buildpack-haskell/cabal.tar.gz"

set -e

BUILD_DIR=$1
CACHE_DIR=$2

mkdir -p $CACHE_DIR

cd $CACHE_DIR

if [ ! -e ghc -o ! -e .cabal ]; then
echo ""
echo "Preparing Haskell Platform..."

if [ ! -e ghc ]; then
echo -n "-----> Fetching GHC... "
curl --silent --max-time 120 -L "$GHC_PACKAGE_URL" | tar xz
echo "done"
fi

if [ ! -e .cabal ]; then
echo -n "-----> Fetching Cabal... "
curl --silent --max-time 120 -L "$CABAL_PACKAGE_URL" | tar xz
echo "done"
fi

fi

echo -n "-----> Bundling GHC... "
GHC_VERSION=`ghc/bin/ghc --version | perl -n -e '/version (\d\.\d\.\d)/ && print $1'`
cp -R ghc /app
echo "version $GHC_VERSION"

echo -n "-----> Bundling Cabal... "
CABAL_VERSION=`.cabal/bin/cabal --version | perl -n -e '/using version ([0-9\.]+) of the Cabal library/ && print $1'`
CABAL_BIN=`pwd`/.cabal/bin/cabal
echo "version $CABAL_VERSION"


echo ""
echo "Running pre-compile actions..."
echo -n "-----> Configuring ghc-pkg... "
ghc/bin/ghc-pkg describe base > base.conf
sed -i "s#ld-options:#ld-options: -L`pwd`/lib#" base.conf
ghc/bin/ghc-pkg update base.conf > /dev/null 2>&1
rm base.conf
echo "done"

echo -n "-----> Updating Cabal... "
export PATH=/app/ghc/bin:$PATH
.cabal/bin/cabal update
echo "done"


echo ""
echo "Beginning compile..."
cd $BUILD_DIR
echo -n "-----> Running cabal install... "
$CABAL_BIN install
echo "done"


echo ""
echo "Running post-compile actions..."
echo -n "-----> Cleaning up..."
echo "done"

